---
title: "Data analysis - Study 1"
# author: "Julio Iturra"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_float:
        collapsed: false
editor_options:
  chunk_output_type: console
---

# Setup

* Controlar por edad individual y padres (edad, edadpad)
* Presentar modelos por pasos (edhigh, educyear, conv)
* Mediacion multinivel 

1 diciembre 2022: 
* agregar la participacion en marcha
  - ols para cada punto
  - multinivel lineal longitudinal  
  - logit binario
  - logit binario multinivel longitudinal
* poner random slope de tiempo para cada sujeto  

16 diciembre:

* marcha pacifica como ordinal | latente con 1 item [X]
* fijar conversacion en t1 (!) [X]
* detallar el footnote los pvalues, controles y tipo de estimación 
* qué es cada modelo
* tabla de variables, likertplot y corplot

* Modelos en participaciones y voto, stepwise:

M1: part ~ edpad + tiempo + tiempo2 + controles
M2: part ~ edpad + conv + tiempo + tiempo2 + controles
M3: part ~ edpad + conv + educ + tiempo + tiempo2 + controles

- modelo de participaciones y voto reportamos M3, pero estimar M1 y M2 para chequear

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      cache = TRUE,
                      results = "hold", 
                      echo = F)
options(scipen=999)
rm(list=ls())
options(knitr.kable.NA = '')
# .rs.restartR()
```

```{css, echo=FALSE}
# /* expandir el espacio del documento*/
body .main-container {
      max-width: 1600px !important;
      width: 1600px !important;
    }
#/* expandir width de la TOC*/
div.tocify {
    width: 22% !important;
    max-width: 331px !important;
    max-height: 102% !important;
}
```

# Models

## Participation Disruptive & Online 

```{r part-edhigh, eval=FALSE, include=FALSE, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               huxtable
               )

load(here::here("input/data/proc/study1.RData"))
data1 <- study_1 %>% 
  dplyr::select(educyear,mujer,edhigh,age,agepavg,conv1a:segu5a,
                "pospolcen","pospolizq","pospolind") %>% na.omit()

m1a<- '
        # modelo de medicion
        disrup1a =~ mdis1a + bloq1a + raya1a + toma1a
        online1a =~ onli1a + post1a + come1a + segu1a

        # (1) modelo de regresion: PARTICIPACION DISRUPTIVA ____________________
        # efecto directo
        disrup1a ~ C1*edhigh+B1A*educyear+B1B*conv1a+mujer+age+agepavg+pospolcen+pospolizq+pospolind
        
        # efecto mediacion predictor sobre mediador (DECLARAR UNA VEZ)
        # educ padres sobre educacion hijos
        educyear ~ A1A*edhigh+mujer+pospolcen+pospolizq+pospolind
        
        # educ padres sobre conversacion hijos
        conv1a ~ A1B*edhigh+mujer+pospolcen+pospolizq+pospolind
        
        # efecto indirecto (A*B)
        # educpadres by educ-hijos (A1)
        ind_dis1_educ:= A1A*B1A 
        # educpadres by conversation (A2)
        ind_dis2_conv:= A1B*B1B

        # total effect
        tot_dis1_educ:= C1 + (A1A*B1A)
        tot_dis2_conv:= C1 + (A1B*B1B)
        
        # (2) modelo de regresion: PARTICIPACION ONLINE ________________________
        # efecto directo
        online1a ~ C2*edhigh+B2A*educyear+B2B*conv1a+mujer+age+agepavg+pospolcen+pospolizq+pospolind
        
        # efecto indirecto (A*B)
        # educpadres by educ-hijos (A2)
        ind_onl_educ:= A1A*B2A 
        # educpadres by conversation (A2)
        ind_onl2_conv:= A1B*B2B

        # total effect
        tot_onl1_educ:= C2 + (A1A*B2A)
        tot_onl2_conv:= C2 + (A1A*B2B)   
'

m2a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "2a")
m3a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "3a")
m4a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "4a")
m5a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "5a")

models <- c(m1a,m2a,m3a,m4a,m5a)

fits <- list()
for (i in 1:length(models)) {
    fits[[i]] <- lavaan::sem(model = models[[i]], data = data1,ordered = T)    
}

fit<- texreg::get.data(l = fits)
filt<- data.frame(coef=fit[[1]]@coef.names)

tabhux <- texreg::huxtablereg(fit,single.row = T)
tabhux2 <- dplyr::filter(tabhux,(grepl(' ~ ', V1)))
tabhux3 <- dplyr::filter(tabhux2,!(grepl('mujer', V1)))
tabhux4 <- dplyr::filter(tabhux3,!(grepl('pospol', V1)))
tabhux5 <- dplyr::filter(tabhux4,!(grepl('age', V1)))
tabhux6 <- dplyr::filter(tabhux5,!(grepl('agepavg', V1)))

fitind <- tabhux %>% filter(V1 %in% c("cfi","tli","rmsea","nobs")) 

tabind_dis <- dplyr::filter(tabhux,(grepl('ind_dis', V1))) 
tabtot_dis <- dplyr::filter(tabhux,(grepl('tot_dis', V1)))

tabind_onl <- dplyr::filter(tabhux,(grepl('ind_onl', V1)))
tabtot_onl <- dplyr::filter(tabhux,(grepl('tot_onl', V1)))

coalesce_all_columns <- function(df) {
  tibble(
    V1 = df$V1[1],
    V2 = na.omit(df$V2),
    V3 = na.omit(df$V3),
    V4 = na.omit(df$V4),
    V5 = na.omit(df$V5),
    V6 = na.omit(df$V6)        
  )
}

#Participacion disruptiva
tabdis <- tabhux6 %>%  dplyr::filter((grepl('disrup', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabdis[tabdis==""] <- NA
tabdis <- tabdis %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind) 

#Participacion online
tabonl <- tabhux6 %>%  dplyr::filter((grepl('online', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabonl[tabonl==""] <- NA  
tabonl <- tabonl %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   

coef <- c("Conversation" ,
  "Years of education - parent highest",
  "Years of education",
  "Ind: Education",
  "Ind: Conversation",
  "Total: Education",
  "Total: Conversation",
  "CFI",
  "RMSEA",
  "TLI",
  "N")

col <- c(" ",paste0("Model ",1:length(fits)))
tabdis$V1 <- coef
tab_dis_educ <- 
kable(tabdis,format = "html",
      booktabs=T,
      row.names = F,
      caption = "Disruptive political participation, parental education and conversation",
      col.names = col) %>% 
  kable_styling(full_width = F)
tab_dis_educ

tabonl$V1 <- coef
tab_onl_educ <- 
kable(tabonl,format = "html",
      booktabs=T,
      row.names = F,
      caption = "Online political participation, parental education and conversation",
      col.names = col) %>% 
  kable_styling(full_width = F) %>% 
  row_spec(7,hline_after = T) 
tab_onl_educ
tables1 <- list(tab_dis_educ,tab_onl_educ)
save(tables1,
     file = here::here("output/tables/tab_educ.RData"))
```

## Participation Disruptive, Online & Peaceful protest 

```{r part-mpas-edhigh, eval=FALSE, include=FALSE, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               huxtable
               )

load(here::here("input/data/proc/study1.RData"))
data1 <- study_1 %>% 
  dplyr::select(educyear,mujer,edhigh,age,agepavg,conv1a:segu5a,
                "pospolcen","pospolizq","pospolind") %>% na.omit()

data1$mpas1a <- scale(as.numeric(data1$mpas1a))
data1$mpas2a <- scale(as.numeric(data1$mpas2a))
data1$mpas3a <- scale(as.numeric(data1$mpas3a))
data1$mpas4a <- scale(as.numeric(data1$mpas4a))
data1$mpas5a <- scale(as.numeric(data1$mpas5a))


m1a<- '
        # modelo de medicion
        disrup1a =~ mdis1a + bloq1a + raya1a + toma1a
        online1a =~ onli1a + post1a + come1a + segu1a


        # (1) modelo de regresion: PARTICIPACION DISRUPTIVA ____________________
        # efecto directo
        disrup1a ~ C1*edhigh+B1A*educyear+B1B*conv1a+mujer+age+agepavg+pospolcen+pospolizq+pospolind
        
        # efecto mediacion predictor sobre mediador (DECLARAR UNA VEZ)
        # educ padres sobre educacion hijos
        educyear ~ A1A*edhigh+mujer+pospolcen+pospolizq+pospolind
        
        # educ padres sobre conversacion hijos
        conv1a ~ A1B*edhigh+mujer+pospolcen+pospolizq+pospolind
        
        # efecto indirecto (A*B)
        # educpadres by educ-hijos (A1)
        ind_dis1_educ:= A1A*B1A 
        # educpadres by conversation (A2)
        ind_dis2_conv:= A1B*B1B

        # total effect
        tot_dis1_educ:= C1 + (A1A*B1A)
        tot_dis2_conv:= C1 + (A1B*B1B)
        
        # (2) modelo de regresion: PARTICIPACION ONLINE ________________________
        # efecto directo
        online1a ~ C2*edhigh+B2A*educyear+B2B*conv1a+mujer+age+agepavg+pospolcen+pospolizq+pospolind
        
        # efecto indirecto (A*B)
        # educpadres by educ-hijos (A2)
        ind_onl_educ:= A1A*B2A 
        # educpadres by conversation (A2)
        ind_onl2_conv:= A1B*B2B

        # total effect
        tot_onl1_educ:= C2 + (A1A*B2A)
        tot_onl2_conv:= C2 + (A1A*B2B)

        # (3) modelo de regresion: PARTICIPACION PACIFICA ______________________
                # efecto directo
        mpas1a ~ C3*edhigh+B3A*educyear+B3B*conv1a+mujer+age+agepavg+pospolcen+pospolizq+pospolind
        
        # efecto indirecto (A*B)
        # educpadres by educ-hijos (A2)
        ind_mar_educ:= A1A*B3A 
        # educpadres by conversation (A2)
        ind_mar2_conv:= A1B*B3B

        # total effect
        tot_mar1_educ:= C2 + (A1A*B3A)
        tot_mar2_conv:= C2 + (A1A*B3B)
'

m2a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "2a")
m3a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "3a")
m4a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "4a")
m5a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "5a")

# fix conversation to moment 1
m2a <- stringr::str_replace_all(string = m2a,pattern = "conv2a",replacement = "conv1a")
m3a <- stringr::str_replace_all(string = m3a,pattern = "conv3a",replacement = "conv1a")
m4a <- stringr::str_replace_all(string = m4a,pattern = "conv4a",replacement = "conv1a")
m5a <- stringr::str_replace_all(string = m5a,pattern = "conv5a",replacement = "conv1a")

models <- c(m1a,m2a,m3a,m4a,m5a)

fits <- list()
for (i in 1:length(models)) {
    fits[[i]] <- lavaan::sem(model = models[[i]], data = data1,ordered = T)    
}

fit<- texreg::get.data(l = fits)
filt<- data.frame(coef=fit[[1]]@coef.names)

tabhux <- texreg::huxtablereg(fit,single.row = T)
tabhux2 <- dplyr::filter(tabhux,(grepl(' ~ ', V1)))
tabhux3 <- dplyr::filter(tabhux2,!(grepl('mujer', V1)))
tabhux4 <- dplyr::filter(tabhux3,!(grepl('pospol', V1)))
tabhux5 <- dplyr::filter(tabhux4,!(grepl('age', V1)))
tabhux6 <- dplyr::filter(tabhux5,!(grepl('agepavg', V1)))

fitind <- tabhux %>% filter(V1 %in% c("cfi","tli","rmsea","nobs")) 

tabind_dis <- dplyr::filter(tabhux,(grepl('ind_dis', V1))) 
tabtot_dis <- dplyr::filter(tabhux,(grepl('tot_dis', V1)))

tabind_onl <- dplyr::filter(tabhux,(grepl('ind_onl', V1)))
tabtot_onl <- dplyr::filter(tabhux,(grepl('tot_onl', V1)))

coalesce_all_columns <- function(df) {
  tibble(
    V1 = df$V1[1],
    V2 = na.omit(df$V2),
    V3 = na.omit(df$V3),
    V4 = na.omit(df$V4),
    V5 = na.omit(df$V5),
    V6 = na.omit(df$V6)        
  )
}

#Participacion disruptiva
tabdis <- tabhux6 %>%  dplyr::filter((grepl('disrup', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabdis[tabdis==""] <- NA
tabdis <- tabdis %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind) 

#Participacion online
tabonl <- tabhux6 %>%  dplyr::filter((grepl('online', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabonl[tabonl==""] <- NA  
tabonl <- tabonl %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   


#Participacion marcha
tabmar <- tabhux6 %>%  dplyr::filter((grepl('mpas', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabmar[tabmar==""] <- NA  
tabmar <- tabmar %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   

coef <- c("Conversation" ,
  "Years of education - parent highest",
  "Years of education",
  "Ind: Education",
  "Ind: Conversation",
  "Total: Education",
  "Total: Conversation",
  "CFI",
  "RMSEA",
  "TLI",
  "N")

col <- c(" ",paste0("Model ",1:length(fits)))
tabdis$V1 <- coef
tab_dis_educ <- 
kable(tabdis,format = "html",
      booktabs=T,
      row.names = F,
      caption = "Disruptive political participation, parental education and conversation",
      col.names = col) %>% 
  kable_styling(full_width = F)
tab_dis_educ

tabonl$V1 <- coef
tab_onl_educ <- 
kable(tabonl,format = "html",
      booktabs=T,
      row.names = F,
      caption = "Online political participation, parental education and conversation",
      col.names = col) %>% 
  kable_styling(full_width = F) %>% 
  row_spec(7,hline_after = T) 
tab_onl_educ

tabmar$V1 <- coef
tab_mar_educ <- 
kable(tabmar,format = "html",
      booktabs=T,
      row.names = F,
      caption = "Participation Peaceful protest, parental education and conversation",
      col.names = col) %>% 
  kable_styling(full_width = F) %>% 
  row_spec(7,hline_after = T) 
tab_mar_educ



tables1 <- list(tab_dis_educ,tab_onl_educ,tab_mar_educ)
save(tables1,
     file = here::here("output/tables/tab_educ_.RData"))
```


```{r part-mpas-edhigh-step, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               tibble,
               lavaan,
               texreg,
               huxtable
               )

load(here::here("input/data/proc/study1.RData"))
data1 <- study_1 %>% 
  dplyr::select(educyear,mujer,edhigh,age,agepavg,conv1a:segu5a,
                "pospolcen","pospolizq","pospolind") %>% na.omit()

data1$mpas1a <- scale(as.numeric(data1$mpas1a))
data1$mpas2a <- scale(as.numeric(data1$mpas2a))
data1$mpas3a <- scale(as.numeric(data1$mpas3a))
data1$mpas4a <- scale(as.numeric(data1$mpas4a))
data1$mpas5a <- scale(as.numeric(data1$mpas5a))

# Model 1: participation  ~ edhigh ---------------------------------------------
m1a<- '
        # modelo de medicion
        disrup1a =~ mdis1a + bloq1a + raya1a + toma1a
        online1a =~ onli1a + post1a + come1a + segu1a


        # (1) modelo de regresion: PARTICIPACION DISRUPTIVA ____________________
        # efecto directo
        disrup1a ~ edhigh+mujer+age+agepavg+pospolcen+pospolizq+pospolind        

        # (2) modelo de regresion: PARTICIPACION ONLINE ________________________
        # efecto directo

        online1a ~ edhigh+mujer+age+agepavg+pospolcen+pospolizq+pospolind          

        # (3) modelo de regresion: PARTICIPACION PACIFICA ______________________
                # efecto directo
        mpas1a ~ edhigh+mujer+age+agepavg+pospolcen+pospolizq+pospolind        
'

m2a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "2a")
m3a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "3a")
m4a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "4a")
m5a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "5a")

# fix conversation to moment 1
m2a <- stringr::str_replace_all(string = m2a,pattern = "conv2a",replacement = "conv1a")
m3a <- stringr::str_replace_all(string = m3a,pattern = "conv3a",replacement = "conv1a")
m4a <- stringr::str_replace_all(string = m4a,pattern = "conv4a",replacement = "conv1a")
m5a <- stringr::str_replace_all(string = m5a,pattern = "conv5a",replacement = "conv1a")

models <- c(m1a,m2a,m3a,m4a,m5a)

fits <- list()
for (i in 1:length(models)) {
    fits[[i]] <- lavaan::sem(model = models[[i]], data = data1,ordered = T)    
}

fit<- texreg::get.data(l = fits)
filt<- data.frame(coef=fit[[1]]@coef.names)

tabhux <- texreg::huxtablereg(fit,single.row = T)
tabhux2 <- dplyr::filter(tabhux,(grepl(' ~ ', V1)))
tabhux3 <- dplyr::filter(tabhux2,!(grepl('mujer', V1)))
tabhux4 <- dplyr::filter(tabhux3,!(grepl('pospol', V1)))
tabhux5 <- dplyr::filter(tabhux4,!(grepl('age', V1)))
tabhux6 <- dplyr::filter(tabhux5,!(grepl('agepavg', V1)))

fitind <- tabhux %>% filter(V1 %in% c("cfi","tli","rmsea","nobs")) 

tabind_dis <- dplyr::filter(tabhux,(grepl('ind_dis', V1))) 
tabtot_dis <- dplyr::filter(tabhux,(grepl('tot_dis', V1)))

tabind_onl <- dplyr::filter(tabhux,(grepl('ind_onl', V1)))
tabtot_onl <- dplyr::filter(tabhux,(grepl('tot_onl', V1)))

coalesce_all_columns <- function(df) {
  tibble(
    V1 = df$V1[1],
    V2 = na.omit(df$V2),
    V3 = na.omit(df$V3),
    V4 = na.omit(df$V4),
    V5 = na.omit(df$V5),
    V6 = na.omit(df$V6)        
  )
}

coef <- c("Years of education - parent highest",
          "CFI","RMSEA","TLI","N")


#Participacion disruptiva
tabdis_m1 <- tabhux6 %>%  dplyr::filter((grepl('disrup', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabdis_m1[tabdis_m1==""] <- NA
tabdis_m1 <- tabdis_m1 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind) 

tabdis_m1$V1 <- coef # replace names of 1st colummn

#Participacion online
tabonl_m1 <- tabhux6 %>%  dplyr::filter((grepl('online', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabonl_m1[tabonl_m1==""] <- NA  
tabonl_m1 <- tabonl_m1 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   

tabonl_m1$V1 <- coef # replace names of 1st colummn

#Participacion marcha
tabmar_m1 <- tabhux6 %>%  dplyr::filter((grepl('mpas', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabmar_m1[tabmar_m1==""] <- NA  
tabmar_m1 <- tabmar_m1 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   

tabmar_m1$V1 <- coef # replace names of 1st colummn

# Model 2 : participation  ~ edhigh + conversation -----------------------------
m1a<- '
        # modelo de medicion
        disrup1a =~ mdis1a + bloq1a + raya1a + toma1a
        online1a =~ onli1a + post1a + come1a + segu1a


        # (1) modelo de regresion: PARTICIPACION DISRUPTIVA ____________________
        # efecto directo
  
        disrup1a ~ edhigh+conv1a+mujer+age+agepavg+pospolcen+pospolizq+pospolind        

        # (2) modelo de regresion: PARTICIPACION ONLINE ________________________
        # efecto directo

        online1a ~ edhigh+conv1a+mujer+age+agepavg+pospolcen+pospolizq+pospolind          

        # (3) modelo de regresion: PARTICIPACION PACIFICA ______________________
                # efecto directo
        mpas1a ~ edhigh+conv1a+mujer+age+agepavg+pospolcen+pospolizq+pospolind        
'

m2a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "2a")
m3a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "3a")
m4a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "4a")
m5a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "5a")

# fix conversation to moment 1
m2a <- stringr::str_replace_all(string = m2a,pattern = "conv2a",replacement = "conv1a")
m3a <- stringr::str_replace_all(string = m3a,pattern = "conv3a",replacement = "conv1a")
m4a <- stringr::str_replace_all(string = m4a,pattern = "conv4a",replacement = "conv1a")
m5a <- stringr::str_replace_all(string = m5a,pattern = "conv5a",replacement = "conv1a")

models <- c(m1a,m2a,m3a,m4a,m5a)

fits <- list()
for (i in 1:length(models)) {
    fits[[i]] <- lavaan::sem(model = models[[i]], data = data1,ordered = T)    
}

fit<- texreg::get.data(l = fits)
filt<- data.frame(coef=fit[[1]]@coef.names)

tabhux <- texreg::huxtablereg(fit,single.row = T)
tabhux2 <- dplyr::filter(tabhux,(grepl(' ~ ', V1)))
tabhux3 <- dplyr::filter(tabhux2,!(grepl('mujer', V1)))
tabhux4 <- dplyr::filter(tabhux3,!(grepl('pospol', V1)))
tabhux5 <- dplyr::filter(tabhux4,!(grepl('age', V1)))
tabhux6 <- dplyr::filter(tabhux5,!(grepl('agepavg', V1)))

fitind <- tabhux %>% filter(V1 %in% c("cfi","tli","rmsea","nobs")) 

tabind_dis <- dplyr::filter(tabhux,(grepl('ind_dis', V1))) 
tabtot_dis <- dplyr::filter(tabhux,(grepl('tot_dis', V1)))

tabind_onl <- dplyr::filter(tabhux,(grepl('ind_onl', V1)))
tabtot_onl <- dplyr::filter(tabhux,(grepl('tot_onl', V1)))

coalesce_all_columns <- function(df) {
  tibble(
    V1 = df$V1[1],
    V2 = na.omit(df$V2),
    V3 = na.omit(df$V3),
    V4 = na.omit(df$V4),
    V5 = na.omit(df$V5),
    V6 = na.omit(df$V6)        
  )
}

coef <- c("Years of education - parent highest",
          "Conversation",
          "CFI","RMSEA","TLI","N")

#Participacion disruptiva
tabdis_m2 <- tabhux6 %>%  dplyr::filter((grepl('disrup', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabdis_m2[tabdis_m2==""] <- NA
tabdis_m2 <- tabdis_m2 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind) 

tabdis_m2 <- tabdis_m2[c(2,1,3:6),] # REORDER rows = educ, conv
tabdis_m2$V1 <- coef # replace names of 1st colummn

#Participacion online
tabonl_m2 <- tabhux6 %>%  dplyr::filter((grepl('online', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabonl_m2[tabonl_m2==""] <- NA  
tabonl_m2 <- tabonl_m2 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   

tabonl_m2 <- tabonl_m2[c(2,1,3:6),] # REORDER rows = educ, conv
tabonl_m2$V1 <- coef # replace names of 1st colummn

#Participacion marcha
tabmar_m2 <- tabhux6 %>%  dplyr::filter((grepl('mpas', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabmar_m2[tabmar_m2==""] <- NA  
tabmar_m2 <- tabmar_m2 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   

tabmar_m2 <- tabmar_m2[c(2,1,3:6),] # REORDER rows = educ, conv
tabmar_m2$V1 <- coef # replace names of 1st colummn

# Model 3 : participation  ~ edhigh + conversation +edyears --------------------
m1a<- '
        # modelo de medicion
        disrup1a =~ mdis1a + bloq1a + raya1a + toma1a
        online1a =~ onli1a + post1a + come1a + segu1a


        # (1) modelo de regresion: PARTICIPACION DISRUPTIVA ____________________
        # efecto directo
  
        disrup1a ~ edhigh+conv1a+educyear+mujer+age+agepavg+pospolcen+pospolizq+pospolind        

        # (2) modelo de regresion: PARTICIPACION ONLINE ________________________
        # efecto directo

        online1a ~ edhigh+conv1a+educyear+mujer+age+agepavg+pospolcen+pospolizq+pospolind          

        # (3) modelo de regresion: PARTICIPACION PACIFICA ______________________
                # efecto directo
        mpas1a ~ edhigh+conv1a+educyear+mujer+age+agepavg+pospolcen+pospolizq+pospolind     
'
m2a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "2a")
m3a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "3a")
m4a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "4a")
m5a <- stringr::str_replace_all(string = m1a,pattern = "1a",replacement = "5a")

# fix conversation to moment 1
m2a <- stringr::str_replace_all(string = m2a,pattern = "conv2a",replacement = "conv1a")
m3a <- stringr::str_replace_all(string = m3a,pattern = "conv3a",replacement = "conv1a")
m4a <- stringr::str_replace_all(string = m4a,pattern = "conv4a",replacement = "conv1a")
m5a <- stringr::str_replace_all(string = m5a,pattern = "conv5a",replacement = "conv1a")

models <- c(m1a,m2a,m3a,m4a,m5a)

fits <- list()
for (i in 1:length(models)) {
    fits[[i]] <- lavaan::sem(model = models[[i]], data = data1,ordered = T)    
}

fit<- texreg::get.data(l = fits)
filt<- data.frame(coef=fit[[1]]@coef.names)

tabhux <- texreg::huxtablereg(fit,single.row = T)
tabhux2 <- dplyr::filter(tabhux,(grepl(' ~ ', V1)))
tabhux3 <- dplyr::filter(tabhux2,!(grepl('mujer', V1)))
tabhux4 <- dplyr::filter(tabhux3,!(grepl('pospol', V1)))
tabhux5 <- dplyr::filter(tabhux4,!(grepl('age', V1)))
tabhux6 <- dplyr::filter(tabhux5,!(grepl('agepavg', V1)))

fitind <- tabhux %>% filter(V1 %in% c("cfi","tli","rmsea","nobs")) 

tabind_dis <- dplyr::filter(tabhux,(grepl('ind_dis', V1))) 
tabtot_dis <- dplyr::filter(tabhux,(grepl('tot_dis', V1)))

tabind_onl <- dplyr::filter(tabhux,(grepl('ind_onl', V1)))
tabtot_onl <- dplyr::filter(tabhux,(grepl('tot_onl', V1)))

coalesce_all_columns <- function(df) {
  tibble(
    V1 = df$V1[1],
    V2 = na.omit(df$V2),
    V3 = na.omit(df$V3),
    V4 = na.omit(df$V4),
    V5 = na.omit(df$V5),
    V6 = na.omit(df$V6)        
  )
}

coef <- c("Years of education - parent highest","Conversation" ,"Years of education",
          "CFI","RMSEA","TLI","N")

#Participacion disruptiva
tabdis_m3 <- tabhux6 %>%  dplyr::filter((grepl('disrup', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabdis_m3[tabdis_m3==""] <- NA
tabdis_m3 <- tabdis_m3 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind) 

tabdis_m3 <- tabdis_m3[c(2,1,3:7),] # REORDER rows = educ, conv, educyear
tabdis_m3$V1 <- coef # replace names of 1st colummn

#Participacion online
tabonl_m3 <- tabhux6 %>%  dplyr::filter((grepl('online', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabonl_m3[tabonl_m3==""] <- NA  
tabonl_m3 <- tabonl_m3 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   

tabonl_m3 <- tabonl_m3[c(2,1,3:7),] # REORDER rows = educ, conv, educyear
tabonl_m3$V1 <- coef # replace names of 1st colummn

#Participacion marcha
tabmar_m3 <- tabhux6 %>%  dplyr::filter((grepl('mpas', V1))) %>% 
  mutate(V1=stringr::str_replace_all(string = V1,
                                     pattern = "1a|2a|3a|4a|5a",
                                     replacement = "")) %>% 
  as.data.frame()
tabmar_m3[tabmar_m3==""] <- NA  
tabmar_m3 <- tabmar_m3 %>%  group_by(V1) %>% do(coalesce_all_columns(.)) %>%  ungroup() %>% 
  rbind(tabind_dis,tabtot_dis,fitind)   

tabmar_m3 <- tabmar_m3[c(2,1,3:7),] # REORDER rows = educ, conv, educyear
tabmar_m3$V1 <- coef # replace names of 1st colummn


# Generate data for tables-----------------------------------------------------
options(knitr.kable.NA = '')
#define headers for table
period<-c(" "=1,"High school (1)"=3,"Oct 2019 - Jan 2020 (2)"=3,
          "Mar - Dec 2020 (3)"=3,"First half: 2021 (4)"=3,"Second half: 2021 (5)"=3)
#define colnames for table
models <- rep(paste0("M",1:3),5)

models_dist <- 
left_join(tabdis_m3,tabdis_m2,by="V1",suffix = c("_3","_2")) %>% 
  left_join(tabdis_m1,by="V1") %>% 
  select(sort(names(.))) %>%
  column_to_rownames(., var = "V1")


kable(models_dist,format = "html",col.names = models,
      booktabs=T,
      row.names = T,
      caption = "Disruptive political participation, parental education and conversation",
      ) %>%
  kable_styling(full_width = F) %>%
  row_spec(7,hline_after = T) %>% 
  add_header_above(period)

models_onl <- 
left_join(tabonl_m3,tabonl_m2,by="V1",suffix = c("_3","_2")) %>% 
  left_join(tabonl_m1,by="V1") %>% 
  select(sort(names(.))) %>%
  column_to_rownames(., var = "V1")

kable(models_onl,format="html",col.names=models,booktabs=T,row.names=T,
      caption = "Online political participation, parental education and conversation") %>%
  kable_styling(full_width = F) %>%
  row_spec(7,hline_after = T) %>% 
  add_header_above(period)


models_mar <- 
left_join(tabmar_m3,tabmar_m2,by="V1",suffix = c("_3","_2")) %>% 
  left_join(tabmar_m1,by="V1") %>% select(sort(names(.))) %>%
  column_to_rownames(., var = "V1")

kable(models_mar,format="html",col.names=models,booktabs=T,row.names=T,
      caption = "Participation Peaceful protest, parental education and conversation") %>%
  kable_styling(full_width = F) %>%
  row_spec(7,hline_after = T) %>% 
  add_header_above(period)
```


## Participation Peaceful protests

- The following models assume the dependent variable as **continuous**    

```{r mpas-edhigh-ols, eval=FALSE, include=FALSE, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               mediation
               )

load(here::here("input/data/proc/study1.RData"))
data1 <- study_1 %>% 
  dplyr::select(-educ,-edmad,-edpad) %>% 
  dplyr::select(mujer,starts_with("conv"),starts_with('mpas'),
         educyear,edhigh,age,agepavg,
         pospolcen,pospolizq,pospolind,pospol 
         ) %>% 
  dplyr::mutate(conv1a=as_numeric(conv1a),
                conv2a=as_numeric(conv2a),
                conv3a=as_numeric(conv3a),
                conv4a=as_numeric(conv4a),
                conv5a=as_numeric(conv5a),
                mpas1a=as_numeric(mpas1a),
                mpas2a=as_numeric(mpas2a),
                mpas3a=as_numeric(mpas3a),
                mpas4a=as_numeric(mpas4a),
                mpas5a=as_numeric(mpas5a)) %>% 
  na.omit()

# view_df(data1)

# sjmisc::frq(data1$votpr17)
# sjmisc::frq(data1$votpleb)
# sjmisc::frq(data1$votcons)

# Hypothesis___________________________________________________________________
m1 <- "edhigh+educyear+conv1a+mujer+age+agepavg+pospol"# highschool
m2 <- "edhigh+educyear+conv2a+mujer+age+agepavg+pospol"# 2019 and 1sem 2020
m3 <- "edhigh+educyear+conv3a+mujer+age+agepavg+pospol"# 2sem 2020
m4 <- "edhigh+educyear+conv4a+mujer+age+agepavg+pospol"# 1sem 2021
m5 <- "edhigh+educyear+conv5a+mujer+age+agepavg+pospol"# 2sem 2021

hipotesis <- c(m1,
               m2,
               m3,
               m4,
               m5
               )

# Set the independent variables (IVs)
ivs1<- "mpas1a"
ivs2<- "mpas2a"
ivs3<- "mpas3a"
ivs4<- "mpas4a"
ivs5<- "mpas5a"

ivs <- c(ivs1,
         ivs2,
         ivs3,ivs4,ivs5)

# Create the object for each model
models <- list()
for (i in ivs1) {
models[[i]] <- paste0(i,"~",m1)  
}

for (i in ivs2) {
models[[i]] <- paste0(i,"~",m2)
}

for (i in ivs3) {
models[[i]] <- paste0(i,"~",m3)  
}

for (i in ivs4) {
models[[i]] <- paste0(i,"~",m4)  
}

for (i in ivs5) {
models[[i]] <- paste0(i,"~",m5)  
}


# Estimate logit models
fits <- list()
for (i in ivs) {
  for (z in models[[i]]) {
    fits[[z]] <- lm(formula =z, data = data1)
  }
}
fit1 <- fits
# change model names within list
names(fit1) <- paste0(ivs)

# Tables_______________________________________________________________________
omit <- "(Intercept)|(mujer)|(pospol)|(age)|(agepavg)"
# detail for subsections:
# https://stackoverflow.com/questions/69338331/r-markdown-create-section-headers-in-r-and-print-r-output-in-same-section

save(fit1,
     file = here::here("output/tables/tab_ols_mpas_educ.RData"))

caption <- "Participation peaceful protest, parental education and conversation"
knitreg(l = fit1[names(fit1)[grepl("mpas", names(fit1),"\n")]],
        omit.coef = omit,
        caption = caption,
        caption.above = T
        # reorder.coef = reorderc
        )

# Mediation analysis___________________________________________________________
mededuc1 <- "edhigh+conv1a+mujer+age+agepavg+pospol"#highschool
mededuc2 <- "edhigh+conv2a+mujer+age+agepavg+pospol"# 2019 + 1sem 2020
mededuc3 <- "edhigh+conv3a+mujer+age+agepavg+pospol"# 2sem 2020
mededuc4 <- "edhigh+conv4a+mujer+age+agepavg+pospol"# 1sem 2021
mededuc5 <- "edhigh+conv5a+mujer+age+agepavg+pospol"# 2sem 2021
mededuc <- c(mededuc1,mededuc2,mededuc3,mededuc4,mededuc5)

medconv1 <- "edhigh+educyear+mujer+age+agepavg+pospol"#highschool
medconv2 <- "edhigh+educyear+mujer+age+agepavg+pospol"# 2019 + 1sem 2020
medconv3 <- "edhigh+educyear+mujer+age+agepavg+pospol"# 2sem 2020
medconv4 <- "edhigh+educyear+mujer+age+agepavg+pospol"# 1sem 2021
medconv5 <- "edhigh+educyear+mujer+age+agepavg+pospol"# 2sem 2021
medconv <- c(medconv1,medconv2,medconv3,medconv4,medconv5)

ivs1 <- c("educyear")
ivs2 <- c("conv1a","conv2a","conv3a","conv4a","conv5a")

# Create the object for each model
lm.educ <- list()
for (i in ivs1) {
lm.educ[[i]] <- paste0(i,"~",mededuc)
}

lm.conv <- list()
for (i in ivs2) {
lm.conv[[i]] <- paste0(i,"~",medconv[[1]])
}


# Estimate OLS models: mediator~predictor
fit_educ <- list()
for (i in ivs1) {
  for (z in lm.educ[[i]]) {
    fit_educ[[z]] <- lm(formula =z, data = data1)
  }
}

fit_conv <- list()
for (i in ivs2) {
  for (z in lm.conv[[i]]) {
    fit_conv[[z]] <- lm(formula =z, data = data1)
  }
}

# change model names within list
names(fit_educ) <- paste0("ed_",ivs2)
# texreg::knitreg(fit_educ)
names(fit_conv) <- paste0("co_",ivs2)
# texreg::knitreg(fit_conv)

# Estimate mediation model_____________________________________________________

############################.
# mediated by Education    #
############################.
medieduc <- list()
for (i in names(fit1)) { 
  for (z in names(fit_educ)) {
medieduc[[i]]<- mediation::mediate(fit_educ[[z]],fit1[[i]], 
                                treat="edhigh", mediator="educyear")    
  }
}

# extract the average mediation effects 
label1 <- 
  stringr::str_remove_all(string = sjlabelled::get_label(study_1[,names(medieduc)]),
                          pattern = ": Participating in peaceful protests")

df_mededuc.ind <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"="Indirect",  
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.ind$effect.avg[[i]] <- medieduc[[i]][["d.avg"]]
  df_mededuc.ind$ci.lwr[[i]] <- medieduc[[i]][["d.avg.ci"]][1]
  df_mededuc.ind$ci.upr[[i]] <- medieduc[[i]][["d.avg.ci"]][2]  
  df_mededuc.ind$pval[[i]] <- medieduc[[i]][["d.avg.p"]]
  }

df_mededuc.dir <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Direct",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.dir$effect.avg[[i]] <- medieduc[[i]][["z.avg"]]
  df_mededuc.dir$ci.lwr[[i]] <- medieduc[[i]][["z.avg.ci"]][1]
  df_mededuc.dir$ci.upr[[i]] <- medieduc[[i]][["z.avg.ci"]][2]  
  df_mededuc.dir$pval[[i]] <- medieduc[[i]][["z.avg.p"]]
  }


df_mededuc.tot <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Total",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.tot$effect.avg[[i]] <- medieduc[[i]][["tau.coef"]]
  df_mededuc.tot$ci.lwr[[i]] <- medieduc[[i]][["tau.ci"]][1]
  df_mededuc.tot$ci.upr[[i]] <- medieduc[[i]][["tau.ci"]][2]  
  df_mededuc.tot$pval[[i]] <- medieduc[[i]][["tau.p"]]
  }

df_mededuc.prop <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Proportion",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.prop$effect.avg[[i]] <- medieduc[[i]][["n.avg"]]
  df_mededuc.prop$ci.lwr[[i]] <- medieduc[[i]][["n.avg.ci"]][1]
  df_mededuc.prop$ci.upr[[i]] <- medieduc[[i]][["n.avg.ci"]][2]  
  df_mededuc.prop$pval[[i]] <- medieduc[[i]][["n.avg.p"]]
  }

df_mededuc <- bind_rows(df_mededuc.ind,df_mededuc.dir,df_mededuc.tot,
                        df_mededuc.prop) %>% 
  arrange(id) %>% 
  mutate(sig=gtools::stars.pval(pval)) %>% 
  dplyr::select(-"id",-"var")

colnames <- c(" ","Type","Effect","Lower CI","Upper CI","p-value","Sig.")
note <- paste0("‘***’ p < 0.001 ‘**’ p < 0.01 ‘*’ p < 0.05 ‘.’ p < 0.1",
               "\nN = ",dim(data1)[[1]])
kable(df_mededuc,format = "html",digits = 3,col.names = colnames, 
      caption = "Mediated effect of Parental Education by Education on 
      Participation on peaceful protests") %>% 
  kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1) %>% 
  footnote(general = note,footnote_as_chunk = T)

############################.
# mediated by conversation #
############################.

# para cada Y debemos estimar un modelo con un M diferente. A diferencia del modelo
# con educacion, el M va cambiando segun T, en cambio en educyears (individuo) es fijo.

mediconv <- list()
for (i in c("mpas1a")) { # High school (1)
  for (z in c("co_conv1a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv1a")    
  }
}

for (i in c("mpas2a")) { # Oct 2019 - Jan 2020 (2)
  for (z in c("co_conv2a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv2a")    
  }
}

for (i in c("mpas3a")) { # Mar - Dec 2020 (3)
  for (z in c("co_conv3a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv3a")    
  }
}

for (i in c("mpas4a")) { # First half: 2021 (4)
  for (z in c("co_conv4a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv4a")    
  }
}

for (i in c("mpas5a")) { # Second half: 2021 (5)
  for (z in c("co_conv5a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv5a")    
  }
}

# extract the average mediation effects 
df_medconv.ind <- data.frame(
  "id"=1:length(mediconv),
  "lab"= label1,  
  "var"=names(mediconv),
  "effect"="Indirect",  
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:(length(medieduc))) {
  df_medconv.ind$effect.avg[[i]] <- mediconv[[i]][["d.avg"]]
  df_medconv.ind$ci.lwr[[i]] <- mediconv[[i]][["d.avg.ci"]][1]
  df_medconv.ind$ci.upr[[i]] <- mediconv[[i]][["d.avg.ci"]][2]  
  df_medconv.ind$pval[[i]] <- mediconv[[i]][["d.avg.p"]]
  }

df_medconv.dir <- data.frame(
  "id"=1:length(mediconv),
  "lab"= label1,  
  "var"=names(mediconv),
  "effect"=rep("Direct",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.dir$effect.avg[[i]] <- mediconv[[i]][["z.avg"]]
  df_medconv.dir$ci.lwr[[i]] <- mediconv[[i]][["z.avg.ci"]][1]
  df_medconv.dir$ci.upr[[i]] <- mediconv[[i]][["z.avg.ci"]][2]  
  df_medconv.dir$pval[[i]] <- mediconv[[i]][["z.avg.p"]]
  }


df_medconv.tot <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Total",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.tot$effect.avg[[i]] <- mediconv[[i]][["tau.coef"]]
  df_medconv.tot$ci.lwr[[i]] <- mediconv[[i]][["tau.ci"]][1]
  df_medconv.tot$ci.upr[[i]] <- mediconv[[i]][["tau.ci"]][2]  
  df_medconv.tot$pval[[i]] <- mediconv[[i]][["tau.p"]]
  }

df_medconv.prop <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Proportion",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.prop$effect.avg[[i]] <- mediconv[[i]][["n.avg"]]
  df_medconv.prop$ci.lwr[[i]] <- mediconv[[i]][["n.avg.ci"]][1]
  df_medconv.prop$ci.upr[[i]] <- mediconv[[i]][["n.avg.ci"]][2]  
  df_medconv.prop$pval[[i]] <- mediconv[[i]][["n.avg.p"]]
  }

df_medconv <- bind_rows(df_medconv.ind,df_medconv.dir,df_medconv.tot,df_medconv.prop) %>% 
  arrange(id) %>% 
  mutate(sig=gtools::stars.pval(pval)) %>% 
  dplyr::select(-"id",-"var")

kable(df_medconv,format = "html",digits = 3, col.names = colnames,
      caption = "Mediated effect of Parental Education by Conversation on
      Participation on peaceful protests") %>% 
  kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1) %>% 
  footnote(general = note,footnote_as_chunk = T)  
```


- The following models assume the dependent variable as **binary**    

```{r mpas-edhigh-logit, eval=FALSE, include=FALSE, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               mediation
               )

load(here::here("input/data/proc/study1.RData"))
data1 <- study_1 %>% 
  dplyr::select(-educ,-edmad,-edpad) %>% 
  dplyr::select(mujer,starts_with("conv"),starts_with('mpas'),
         educyear,edhigh,age,agepavg,
         pospolcen,pospolizq,pospolind,pospol 
         ) %>% 
  dplyr::mutate(conv1a=as_numeric(conv1a),
                conv2a=as_numeric(conv2a),
                conv3a=as_numeric(conv3a),
                conv4a=as_numeric(conv4a),
                conv5a=as_numeric(conv5a),
                mpas1a=as_numeric(mpas1a_bi),
                mpas2a=as_numeric(mpas2a_bi),
                mpas3a=as_numeric(mpas3a_bi),
                mpas4a=as_numeric(mpas4a_bi),
                mpas5a=as_numeric(mpas5a_bi)) %>% 
  na.omit()

# view_df(data1)

# sjmisc::frq(data1$votpr17)
# sjmisc::frq(data1$votpleb)
# sjmisc::frq(data1$votcons)

# Hypothesis___________________________________________________________________
m1 <- "edhigh+educyear+conv1a+mujer+age+agepavg+pospol"# highschool
m2 <- "edhigh+educyear+conv2a+mujer+age+agepavg+pospol"# 2019 and 1sem 2020
m3 <- "edhigh+educyear+conv3a+mujer+age+agepavg+pospol"# 2sem 2020
m4 <- "edhigh+educyear+conv4a+mujer+age+agepavg+pospol"# 1sem 2021
m5 <- "edhigh+educyear+conv5a+mujer+age+agepavg+pospol"# 2sem 2021

hipotesis <- c(m1,
               m2,
               m3,
               m4,
               m5
               )

# Set the independent variables (IVs)
ivs1<- "mpas1a_bi"
ivs2<- "mpas2a_bi"
ivs3<- "mpas3a_bi"
ivs4<- "mpas4a_bi"
ivs5<- "mpas5a_bi"

ivs <- c(ivs1,
         ivs2,
         ivs3,ivs4,ivs5)

# Create the object for each model
models <- list()
for (i in ivs1) {
models[[i]] <- paste0(i,"~",m1)  
}

for (i in ivs2) {
models[[i]] <- paste0(i,"~",m2)
}

for (i in ivs3) {
models[[i]] <- paste0(i,"~",m3)  
}

for (i in ivs4) {
models[[i]] <- paste0(i,"~",m4)  
}

for (i in ivs5) {
models[[i]] <- paste0(i,"~",m5)  
}


# Estimate logit models
fits <- list()
for (i in ivs) {
  for (z in models[[i]]) {
    fits[[z]] <- glm(formula =z, data = data1,family = "binomial")
  }
}
fit1 <- fits
# change model names within list
names(fit1) <- paste0(ivs)
# Tables_______________________________________________________________________
omit <- "(Intercept)|(mujer)|(pospol)|(age)|(agepavg)"
# detail for subsections:
# https://stackoverflow.com/questions/69338331/r-markdown-create-section-headers-in-r-and-print-r-output-in-same-section

save(fit1,
     file = here::here("output/tables/tab_log_mpas_educ.RData"))

caption <- "Participation peaceful protest, parental education and conversation"
knitreg(l = fit1[names(fit1)[grepl("mpas", names(fit1),"\n")]],
        omit.coef = omit,
        caption = caption,
        caption.above = T
        # reorder.coef = reorderc
        )

# Mediation analysis___________________________________________________________
mededuc1 <- "edhigh+conv1a+mujer+age+agepavg+pospol"#highschool
mededuc2 <- "edhigh+conv2a+mujer+age+agepavg+pospol"# 2019 + 1sem 2020
mededuc3 <- "edhigh+conv3a+mujer+age+agepavg+pospol"# 2sem 2020
mededuc4 <- "edhigh+conv4a+mujer+age+agepavg+pospol"# 1sem 2021
mededuc5 <- "edhigh+conv5a+mujer+age+agepavg+pospol"# 2sem 2021
mededuc <- c(mededuc1,mededuc2,mededuc3,mededuc4,mededuc5)

medconv1 <- "edhigh+educyear+mujer+age+agepavg+pospol"#highschool
medconv2 <- "edhigh+educyear+mujer+age+agepavg+pospol"# 2019 + 1sem 2020
medconv3 <- "edhigh+educyear+mujer+age+agepavg+pospol"# 2sem 2020
medconv4 <- "edhigh+educyear+mujer+age+agepavg+pospol"# 1sem 2021
medconv5 <- "edhigh+educyear+mujer+age+agepavg+pospol"# 2sem 2021
medconv <- c(medconv1,medconv2,medconv3,medconv4,medconv5)

ivs1 <- c("educyear")
ivs2 <- c("conv1a","conv2a","conv3a","conv4a","conv5a")

# Create the object for each model
lm.educ <- list()
for (i in ivs1) {
lm.educ[[i]] <- paste0(i,"~",mededuc)
}

lm.conv <- list()
for (i in ivs2) {
lm.conv[[i]] <- paste0(i,"~",medconv[[1]])
}


# Estimate OLS models: mediator~predictor
fit_educ <- list()
for (i in ivs1) {
  for (z in lm.educ[[i]]) {
    fit_educ[[z]] <- lm(formula =z, data = data1)
  }
}

fit_conv <- list()
for (i in ivs2) {
  for (z in lm.conv[[i]]) {
    fit_conv[[z]] <- lm(formula =z, data = data1)
  }
}

# change model names within list
names(fit_educ) <- paste0("ed_",ivs2)
# texreg::knitreg(fit_educ)
names(fit_conv) <- paste0("co_",ivs2)
# texreg::knitreg(fit_conv)

# Estimate mediation model_____________________________________________________

############################.
# mediated by Education    #
############################.
medieduc <- list()
for (i in names(fit1)) { 
  for (z in names(fit_educ)) {
medieduc[[i]]<- mediation::mediate(fit_educ[[z]],fit1[[i]], 
                                treat="edhigh", mediator="educyear")    
  }
}

# extract the average mediation effects 
label1 <- 
  stringr::str_remove_all(string = sjlabelled::get_label(study_1[,names(medieduc)]),
                          pattern = ": Participating in peaceful protests")

df_mededuc.ind <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"="Indirect",  
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.ind$effect.avg[[i]] <- medieduc[[i]][["d.avg"]]
  df_mededuc.ind$ci.lwr[[i]] <- medieduc[[i]][["d.avg.ci"]][1]
  df_mededuc.ind$ci.upr[[i]] <- medieduc[[i]][["d.avg.ci"]][2]  
  df_mededuc.ind$pval[[i]] <- medieduc[[i]][["d.avg.p"]]
  }

df_mededuc.dir <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Direct",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.dir$effect.avg[[i]] <- medieduc[[i]][["z.avg"]]
  df_mededuc.dir$ci.lwr[[i]] <- medieduc[[i]][["z.avg.ci"]][1]
  df_mededuc.dir$ci.upr[[i]] <- medieduc[[i]][["z.avg.ci"]][2]  
  df_mededuc.dir$pval[[i]] <- medieduc[[i]][["z.avg.p"]]
  }


df_mededuc.tot <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Total",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.tot$effect.avg[[i]] <- medieduc[[i]][["tau.coef"]]
  df_mededuc.tot$ci.lwr[[i]] <- medieduc[[i]][["tau.ci"]][1]
  df_mededuc.tot$ci.upr[[i]] <- medieduc[[i]][["tau.ci"]][2]  
  df_mededuc.tot$pval[[i]] <- medieduc[[i]][["tau.p"]]
  }

df_mededuc.prop <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Proportion",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.prop$effect.avg[[i]] <- medieduc[[i]][["n.avg"]]
  df_mededuc.prop$ci.lwr[[i]] <- medieduc[[i]][["n.avg.ci"]][1]
  df_mededuc.prop$ci.upr[[i]] <- medieduc[[i]][["n.avg.ci"]][2]  
  df_mededuc.prop$pval[[i]] <- medieduc[[i]][["n.avg.p"]]
  }

df_mededuc <- bind_rows(df_mededuc.ind,df_mededuc.dir,df_mededuc.tot,
                        df_mededuc.prop) %>% 
  arrange(id) %>% 
  mutate(sig=gtools::stars.pval(pval)) %>% 
  dplyr::select(-"id",-"var")

colnames <- c(" ","Type","Effect","Lower CI","Upper CI","p-value","Sig.")
note <- paste0("‘***’ p < 0.001 ‘**’ p < 0.01 ‘*’ p < 0.05 ‘.’ p < 0.1",
               "\nN = ",dim(data1)[[1]])
kable(df_mededuc,format = "html",digits = 3,col.names = colnames, 
      caption = "Mediated effect of Parental Education by Education on 
      Participation on peaceful protests") %>% 
  kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1) %>% 
  footnote(general = note,footnote_as_chunk = T)

############################.
# mediated by conversation #
############################.

# para cada Y debemos estimar un modelo con un M diferente. A diferencia del modelo
# con educacion, el M va cambiando segun T, en cambio en educyears (individuo) es fijo.

mediconv <- list()
for (i in c("mpas1a_bi")) { # High school (1)
  for (z in c("co_conv1a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv1a")    
  }
}

for (i in c("mpas2a_bi")) { # Oct 2019 - Jan 2020 (2)
  for (z in c("co_conv2a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv2a")    
  }
}

for (i in c("mpas3a_bi")) { # Mar - Dec 2020 (3)
  for (z in c("co_conv3a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv3a")    
  }
}

for (i in c("mpas4a_bi")) { # First half: 2021 (4)
  for (z in c("co_conv4a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv4a")    
  }
}

for (i in c("mpas5a_bi")) { # Second half: 2021 (5)
  for (z in c("co_conv5a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv5a")    
  }
}

# extract the average mediation effects 
df_medconv.ind <- data.frame(
  "id"=1:length(mediconv),
  "lab"= label1,  
  "var"=names(mediconv),
  "effect"="Indirect",  
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:(length(medieduc))) {
  df_medconv.ind$effect.avg[[i]] <- mediconv[[i]][["d.avg"]]
  df_medconv.ind$ci.lwr[[i]] <- mediconv[[i]][["d.avg.ci"]][1]
  df_medconv.ind$ci.upr[[i]] <- mediconv[[i]][["d.avg.ci"]][2]  
  df_medconv.ind$pval[[i]] <- mediconv[[i]][["d.avg.p"]]
  }

df_medconv.dir <- data.frame(
  "id"=1:length(mediconv),
  "lab"= label1,  
  "var"=names(mediconv),
  "effect"=rep("Direct",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.dir$effect.avg[[i]] <- mediconv[[i]][["z.avg"]]
  df_medconv.dir$ci.lwr[[i]] <- mediconv[[i]][["z.avg.ci"]][1]
  df_medconv.dir$ci.upr[[i]] <- mediconv[[i]][["z.avg.ci"]][2]  
  df_medconv.dir$pval[[i]] <- mediconv[[i]][["z.avg.p"]]
  }


df_medconv.tot <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Total",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.tot$effect.avg[[i]] <- mediconv[[i]][["tau.coef"]]
  df_medconv.tot$ci.lwr[[i]] <- mediconv[[i]][["tau.ci"]][1]
  df_medconv.tot$ci.upr[[i]] <- mediconv[[i]][["tau.ci"]][2]  
  df_medconv.tot$pval[[i]] <- mediconv[[i]][["tau.p"]]
  }

df_medconv.prop <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Proportion",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.prop$effect.avg[[i]] <- mediconv[[i]][["n.avg"]]
  df_medconv.prop$ci.lwr[[i]] <- mediconv[[i]][["n.avg.ci"]][1]
  df_medconv.prop$ci.upr[[i]] <- mediconv[[i]][["n.avg.ci"]][2]  
  df_medconv.prop$pval[[i]] <- mediconv[[i]][["n.avg.p"]]
  }

df_medconv <- bind_rows(df_medconv.ind,df_medconv.dir,df_medconv.tot,
                        df_medconv.prop) %>% 
  arrange(id) %>% 
  mutate(sig=gtools::stars.pval(pval)) %>% 
  dplyr::select(-"id",-"var")

kable(df_medconv,format = "html",digits = 3, col.names = colnames,
      caption = "Mediated effect of Parental Education by Conversation on
      Participation on peaceful protests") %>% 
  kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1) %>% 
  footnote(general = note,footnote_as_chunk = T)  
```

The following models assume the dependent variable as **continuous** using the longitudinal nested structure 

```{r mpas-long, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               mediation,
               estimatr,
               bife
               )
load(here::here("input/data/proc/study1_long.RData"))

data1<- 
study_1_long %>% 
  dplyr::select(folio_encuestado,momento,mpas,educyear,age,agepavg,edhigh,conv_t1,conv,
                mujer,pospol) %>%
  mutate(
    conv_t1=as.numeric(conv_t1),
    conv=as.numeric(conv),
    mpas=as.numeric(mpas)
         )  %>% 
  na.omit()
# dim(data1)

# Models-----------------------------------------------------------------------
mpasnull <- 
lme4::lmer(mpas~1+(1|folio_encuestado),
            data = data1)

mpas_conv <- 
lme4::lmer(mpas~edhigh+educyear+conv+mujer+age+agepavg+pospol+momento+I(momento^2)+(1|folio_encuestado),
            data = data1)
mpas_conv_re_t <- 
lme4::lmer(mpas~edhigh+educyear+conv+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1)

mpas_conv_int <- 
lme4::lmer(mpas~edhigh*momento+educyear+conv+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1)

mpas_convfix <- 
lme4::lmer(mpas~edhigh+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1|folio_encuestado),
            data = data1)
mpas_convfix_re_t <- 
lme4::lmer(mpas~edhigh+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1)

mpas_convfix_int1 <- 
lme4::lmer(mpas~edhigh*momento+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1)

mpas_convfix_int2 <- 
lme4::lmer(mpas~edhigh+educyear+conv_t1*momento+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1)


# summary(mpas)

# Table ------------------------------------------------------------------------
mpasifica <- list(mpasnull,
                  mpas_conv,mpas_conv_re_t,mpas_conv_int,
                  mpas_convfix,mpas_convfix_re_t,mpas_convfix_int1,mpas_convfix_int2)
caption <- "Multilevel longitudinal linear regression for Participation on peaceful protests"
knitreg(mpasifica,
        include.ci = FALSE,
        omit.coef = c("(pospol)|(mujer)|(age)|(agepavg)"),
        caption.above = T,caption = caption,
        )

```

- The following models assume the dependent variable as **binary** using the longitudinal nested structure 

```{r mpas-long-log, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               mediation,
               estimatr,
               bife
               )
load(here::here("input/data/proc/study1_long.RData"))

data1<- 
study_1_long %>% 
  dplyr::select(folio_encuestado,momento,mpas_bi,educyear,age,agepavg,edhigh,conv_t1,conv,
                mujer,pospol) %>%
  mutate(
    conv_t1=as.numeric(conv_t1),
    conv=as.numeric(conv),
    mpas_bi=as.numeric(mpas_bi)
         )  %>% 
  na.omit()
dim(data1)

data1$mpas_bi <- car::recode(data1$mpas_bi,"1=0;2=1")
# class(data1$mpas_bi)
# table(data1$mpas_bi)

# Models-----------------------------------------------------------------------
mpasnull <- 
lme4::glmer(mpas_bi~1+(1|folio_encuestado),
            data = data1,family = "binomial")
# 9.75/(3.29+9.75)
# sjstats::icc(mpasnull)[[1]]
# pdata <- panelr::panel_data(data1, id = folio_encuestado, wave = momento)
# model <- panelr::wbm(vot ~  edhigh+educyear+conv_t1+mujer+pospol, data = pdata,use.wave = T, family = binomial,model = "random")
# summary(model)

mpas_conv <- 
lme4::lmer(mpas_bi~edhigh+educyear+conv+mujer+age+agepavg+pospol+momento+I(momento^2)+(1|folio_encuestado),
            data = data1,
           # family = "binomial"
           )
mpas_conv_re_t <- 
lme4::lmer(mpas_bi~edhigh+educyear+conv+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1,
           # family = "binomial"
           )

mpas_conv_int <- 
lme4::lmer(mpas_bi~edhigh*momento+educyear+conv+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1,
           # family = "binomial"
           )

mpas_convfix <- 
lme4::lmer(mpas_bi~edhigh+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1|folio_encuestado),
            data = data1,
           # family = "binomial"
           )
mpas_convfix_re_t <- 
lme4::lmer(mpas_bi~edhigh+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1,
           # family = "binomial"
           )

mpas_convfix_int1 <- 
lme4::lmer(mpas_bi~edhigh*momento+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1,
           # family = "binomial"
           )

mpas_convfix_int2 <- 
lme4::lmer(mpas_bi~edhigh+educyear+conv_t1*momento+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1,
           # family = "binomial"
           )


# summary(mpas)

# Table ------------------------------------------------------------------------
mpasifica <- list(mpasnull,
                  mpas_conv,mpas_conv_re_t,mpas_conv_int,
                  mpas_convfix,mpas_convfix_re_t,mpas_convfix_int1,mpas_convfix_int2)
caption <- "Multilevel longitudinal linear probability regression for Participation on peaceful protests"
knitreg(mpasifica,
        include.ci = FALSE,
        omit.coef = c("(pospol)|(mujer)|(age)|(agepavg)|(Intercept)"),
        caption.above = T,caption = caption,
          # custom.gof.rows = list("ICC"=c(sjstats::icc(votonull)[[1]],
          # sjstats::icc(voto)[[2]])),
        )

# logit2prob <- function(logit){
#   odds <- exp(logit)
#   prob <- odds / (1 + odds)
#   return(prob)
# }

# logit2prob(lme4::fixef(votonull))
# logit2prob(lme4::fixef(voto))

# set.seed(1234)
# if (!require("glmmTMB")) install.packages("glmmTMB") # instalar pacman

# plot_model(model = mpas,type = "re",sort.est = "sort.all",
#            grid = F,
#            transform = NULL,
#            axis.labels = c(1:961))
# plot_model(model = voto,type = "pred",terms = "edhigh")
# plot_model(model = voto,type = "pred",terms = "educyear")
```

## Voting behaviour 

- The following models assume the dependent variable as **binary**

```{r vot-edhigh, eval=FALSE, include=FALSE, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               mediation
               )

load(here::here("input/data/proc/study1.RData"))
data1 <- study_1 %>% 
  dplyr::select(-educ,-edmad,-edpad) %>% 
  dplyr::filter(votpr17 !=2 & votpleb !=2 & votcons !=2) %>%
  dplyr::select(mujer:conv5a,votpr17:vot2vue,
         educyear,edhigh,psu,
         pospolcen,pospolizq,pospolind,pospol 
         ) %>% 
  dplyr::mutate(conv1a=as_numeric(conv1a),
         conv3a=as_numeric(conv3a),
         conv4a=as_numeric(conv4a),
         conv5a=as_numeric(conv5a)) %>% 
  na.omit()

# view_df(data1)

# sjmisc::frq(data1$votpr17)
# sjmisc::frq(data1$votpleb)
# sjmisc::frq(data1$votcons)

# Hypothesis___________________________________________________________________
m1 <- "edhigh+educyear+conv1a+mujer+pospol"#highschool
m2 <- "edhigh+educyear+conv3a+mujer+pospol"# 2sem 2020
m3 <- "edhigh+educyear+conv4a+mujer+pospol"# 1sem 2021
m4 <- "edhigh+educyear+conv5a+mujer+pospol"# 2sem 2021

hipotesis <- c(m1,
               # m2,
               m3,
               m4)

# Set the independent variables (IVs)
ivs1<- data1 %>% dplyr::select(votpr17) %>% names()        #highschool
ivs2<- data1 %>% dplyr::select(votpleb) %>% names()        # 2sem 2020
ivs3<- data1 %>% dplyr::select(votconv:votmuni) %>% names()# 1sem 2021
ivs4<- data1 %>% dplyr::select(votdipu:vot2vue) %>% names()# 2sem 2021

ivs <- c(ivs1,
         ivs2,
         ivs3,ivs4)

# Create the object for each model
models <- list()
for (i in ivs1) {
models[[i]] <- paste0(i,"~",m1)  
}

for (i in ivs2) {
models[[i]] <- paste0(i,"~",m2)
}

for (i in ivs3) {
models[[i]] <- paste0(i,"~",m3)  
}

for (i in ivs4) {
models[[i]] <- paste0(i,"~",m4)  
}

# Estimate logit models
fits <- list()
for (i in ivs) {
  for (z in models[[i]]) {
    fits[[z]] <- glm(formula =z, data = data1,family = "binomial")
  }
}
fit1 <- fits
# change model names within list
names(fit1) <- paste0(ivs)

# Tables_______________________________________________________________________
omit <- "(Intercept)|(mujer)|(pospol)"
# detail for subsections:
# https://stackoverflow.com/questions/69338331/r-markdown-create-section-headers-in-r-and-print-r-output-in-same-section

save(fit1,
     file = here::here("output/tables/tab__logit_vote_educ.RData"))

caption <- "Voting behaviour, parental education and conversation"
knitreg(l = fit1[names(fit1)[grepl("vot", names(fit1),"\n")]],
        omit.coef = omit,
        caption = caption,
        caption.above = T
        # reorder.coef = reorderc
        )

# Mediation analysis___________________________________________________________
mededuc1 <- "edhigh+conv1a+mujer+pospol"#highschool
mededuc2 <- "edhigh+conv3a+mujer+pospol"# 2sem 2020
mededuc3 <- "edhigh+conv4a+mujer+pospol"# 1sem 2021
mededuc4 <- "edhigh+conv5a+mujer+pospol"# 2sem 2021
mededuc <- c(mededuc1,mededuc2,mededuc3,mededuc4)

medconv1 <- "edhigh+educyear+mujer+pospol"#highschool
medconv2 <- "edhigh+educyear+mujer+pospol"# 2sem 2020
medconv3 <- "edhigh+educyear+mujer+pospol"# 1sem 2021
medconv4 <- "edhigh+educyear+mujer+pospol"# 2sem 2021
medconv <- c(medconv1,medconv2,medconv3,medconv4)

ivs1 <- c("educyear")
ivs2 <- c("conv1a","conv3a","conv4a","conv5a")

# Create the object for each model
lm.educ <- list()
for (i in ivs1) {
lm.educ[[i]] <- paste0(i,"~",mededuc)
}

lm.conv <- list()
for (i in ivs2) {
lm.conv[[i]] <- paste0(i,"~",medconv)
}


# Estimate OLS models: mediator~predictor
fit_educ <- list()
for (i in ivs1) {
  for (z in lm.educ[[i]]) {
    fit_educ[[z]] <- lm(formula =z, data = data1)
  }
}


fit_conv <- list()
for (i in ivs2) {
  for (z in lm.conv[[i]]) {
    fit_conv[[z]] <- lm(formula =z, data = data1)
  }
}

# change model names within list
names(fit_educ) <- paste0("ed_",ivs2)
names(fit_conv) <- paste0("co_",ivs2)

# Estimate mediation model_____________________________________________________

############################.
# mediated by Education    #
############################.
medieduc <- list()
for (i in c("votpr17")) {
  for (z in c("ed_conv1a")) {
medieduc[[i]]<- mediation::mediate(fit_educ[[z]],fit1[[i]], 
                                treat="edhigh", mediator="educyear")    
  }
}

for (i in "votpleb") {
  for (z in "ed_conv3a") {
medieduc[[i]]<- mediation::mediate(fit_educ[[z]],fit1[[i]], 
                                treat="edhigh", mediator="educyear")    
  }
}


for (i in c("votconv","votmuni")) {
  for (z in "ed_conv4a") {
medieduc[[i]]<- mediation::mediate(fit_educ[[z]],fit1[[i]], 
                                treat="edhigh", mediator="educyear")    
  }
}

for (i in c("votdipu","vot1vue","vot2vue")) {
  for (z in "ed_conv5a") {
medieduc[[i]]<- mediation::mediate(fit_educ[[z]],fit1[[i]],  
                                treat="edhigh", mediator="educyear")    
  }
}


# extract the average mediation effects 
label1 <- 
  stringr::str_remove_all(string = sjlabelled::get_label(study_1[,names(medieduc)]),
                          pattern = "Vote: ")

df_mededuc.ind <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"="Indirect",  
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.ind$effect.avg[[i]] <- medieduc[[i]][["d.avg"]]
  df_mededuc.ind$ci.lwr[[i]] <- medieduc[[i]][["d.avg.ci"]][1]
  df_mededuc.ind$ci.upr[[i]] <- medieduc[[i]][["d.avg.ci"]][2]  
  df_mededuc.ind$pval[[i]] <- medieduc[[i]][["d.avg.p"]]
  }

df_mededuc.dir <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Direct",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.dir$effect.avg[[i]] <- medieduc[[i]][["z.avg"]]
  df_mededuc.dir$ci.lwr[[i]] <- medieduc[[i]][["z.avg.ci"]][1]
  df_mededuc.dir$ci.upr[[i]] <- medieduc[[i]][["z.avg.ci"]][2]  
  df_mededuc.dir$pval[[i]] <- medieduc[[i]][["z.avg.p"]]
  }


df_mededuc.tot <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Total",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.tot$effect.avg[[i]] <- medieduc[[i]][["tau.coef"]]
  df_mededuc.tot$ci.lwr[[i]] <- medieduc[[i]][["tau.ci"]][1]
  df_mededuc.tot$ci.upr[[i]] <- medieduc[[i]][["tau.ci"]][2]  
  df_mededuc.tot$pval[[i]] <- medieduc[[i]][["tau.p"]]
  }

df_mededuc.prop <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Proportion",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_mededuc.prop$effect.avg[[i]] <- medieduc[[i]][["n.avg"]]
  df_mededuc.prop$ci.lwr[[i]] <- medieduc[[i]][["n.avg.ci"]][1]
  df_mededuc.prop$ci.upr[[i]] <- medieduc[[i]][["n.avg.ci"]][2]  
  df_mededuc.prop$pval[[i]] <- medieduc[[i]][["n.avg.p"]]
  }

df_mededuc <- bind_rows(df_mededuc.ind,df_mededuc.dir,df_mededuc.tot,df_mededuc.prop) %>% 
  arrange(id) %>% 
  mutate(sig=gtools::stars.pval(pval)) %>% 
  dplyr::select(-"id",-"var")



colnames <- c(" ","Type","Effect","Lower CI","Upper CI","p-value","Sig.")
note <- "‘***’ p < 0.001 ‘**’ p < 0.01 ‘*’ p < 0.05 ‘.’ p < 0.1"
kable(df_mededuc,format = "html",digits = 3,col.names = colnames, 
      caption = "Mediated effect of Parental Education by Education on Voting behaviour") %>% 
  kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1) %>% 
  footnote(general = note,footnote_as_chunk = T)

############################.
# mediated by conversation #
############################.

mediconv <- list()
for (i in c("votpr17")) {
  for (z in c("co_conv1a")) {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv1a")    
  }
}

for (i in "votpleb") {
  for (z in "co_conv3a") {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]], 
                                treat="edhigh", mediator="conv3a")    
  }
}


for (i in c("votconv","votmuni")) {
  for (z in "co_conv4a") {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]],
                                treat="edhigh", mediator="conv4a")    
  }
}

for (i in c("votdipu","vot1vue","vot2vue")) {
  for (z in "co_conv5a") {
mediconv[[i]]<- mediation::mediate(fit_conv[[z]],fit1[[i]],
                                treat="edhigh", mediator="conv5a")    
  }
}

# extract the average mediation effects 
df_medconv.ind <- data.frame(
  "id"=1:length(mediconv),
  "lab"= label1,  
  "var"=names(mediconv),
  "effect"="Indirect",  
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:(length(medieduc))) {
  df_medconv.ind$effect.avg[[i]] <- mediconv[[i]][["d.avg"]]
  df_medconv.ind$ci.lwr[[i]] <- mediconv[[i]][["d.avg.ci"]][1]
  df_medconv.ind$ci.upr[[i]] <- mediconv[[i]][["d.avg.ci"]][2]  
  df_medconv.ind$pval[[i]] <- mediconv[[i]][["d.avg.p"]]
  }

df_medconv.dir <- data.frame(
  "id"=1:length(mediconv),
  "lab"= label1,  
  "var"=names(mediconv),
  "effect"=rep("Direct",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.dir$effect.avg[[i]] <- mediconv[[i]][["z.avg"]]
  df_medconv.dir$ci.lwr[[i]] <- mediconv[[i]][["z.avg.ci"]][1]
  df_medconv.dir$ci.upr[[i]] <- mediconv[[i]][["z.avg.ci"]][2]  
  df_medconv.dir$pval[[i]] <- mediconv[[i]][["z.avg.p"]]
  }


df_medconv.tot <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Total",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.tot$effect.avg[[i]] <- mediconv[[i]][["tau.coef"]]
  df_medconv.tot$ci.lwr[[i]] <- mediconv[[i]][["tau.ci"]][1]
  df_medconv.tot$ci.upr[[i]] <- mediconv[[i]][["tau.ci"]][2]  
  df_medconv.tot$pval[[i]] <- mediconv[[i]][["tau.p"]]
  }

df_medconv.prop <- data.frame(
  "id"=1:length(medieduc),
  "lab"= label1,  
  "var"=names(medieduc),
  "effect"=rep("Proportion",max(length(medieduc))),
  "effect.avg"=NA,
  "ci.lwr"=NA,
  "ci.upr"=NA,
  "pval"=NA)

for (i in 1:length(medieduc)) {
  df_medconv.prop$effect.avg[[i]] <- mediconv[[i]][["n.avg"]]
  df_medconv.prop$ci.lwr[[i]] <- mediconv[[i]][["n.avg.ci"]][1]
  df_medconv.prop$ci.upr[[i]] <- mediconv[[i]][["n.avg.ci"]][2]  
  df_medconv.prop$pval[[i]] <- mediconv[[i]][["n.avg.p"]]
  }

df_medconv <- bind_rows(df_medconv.ind,df_medconv.dir,df_medconv.tot,df_medconv.prop) %>% 
  arrange(id) %>% 
  mutate(sig=gtools::stars.pval(pval)) %>% 
  dplyr::select(-"id",-"var")

kable(df_medconv,format = "html",digits = 3, col.names = colnames,
      caption = "Mediated effect of Parental Education by Conversation on Voting behaviour") %>% 
  kable_styling(full_width = F) %>% 
  collapse_rows(columns = 1) %>% 
  footnote(general = note,footnote_as_chunk = T)  
```

```{r vot-edhigh-conv1, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               mediation
               )

load(here::here("input/data/proc/study1.RData"))
data1 <- study_1 %>% 
  dplyr::select(-educ,-edmad,-edpad) %>% 
  dplyr::filter(votpr17 !=2 & votpleb !=2 & votcons !=2) %>%
  dplyr::select(mujer:conv5a,votpr17:vot2vue,
         educyear,edhigh,psu,
         pospolcen,pospolizq,pospolind,pospol 
         ) %>% 
  dplyr::mutate(conv1a=as_numeric(conv1a),
         conv3a=as_numeric(conv3a),
         conv4a=as_numeric(conv4a),
         conv5a=as_numeric(conv5a)) %>% 
  na.omit()

# view_df(data1)

# sjmisc::frq(data1$votpr17)
# sjmisc::frq(data1$votpleb)
# sjmisc::frq(data1$votcons)

# Hypothesis___________________________________________________________________
m1 <- "edhigh+educyear+conv1a+mujer+pospol"#highschool
# m2 <- "edhigh+educyear+conv3a+mujer+pospol"# 2sem 2020
# m3 <- "edhigh+educyear+conv4a+mujer+pospol"# 1sem 2021
# m4 <- "edhigh+educyear+conv5a+mujer+pospol"# 2sem 2021

hipotesis <- c(m1
               # m2,m3,m4
               )

# Set the independent variables (IVs)
ivs1<- data1 %>% dplyr::select(votpr17) %>% names()        #highschool
ivs2<- data1 %>% dplyr::select(votpleb) %>% names()        # 2sem 2020
ivs3<- data1 %>% dplyr::select(votconv:votmuni) %>% names()# 1sem 2021
ivs4<- data1 %>% dplyr::select(votdipu:vot2vue) %>% names()# 2sem 2021

ivs <- c(ivs1,ivs2,ivs3,ivs4)

# Create the object for each model
models <- list()
for (i in ivs1) {
models[[i]] <- paste0(i,"~",m1)  
}

for (i in ivs2) {
models[[i]] <- paste0(i,"~",m1)  
}

for (i in ivs3) {
models[[i]] <- paste0(i,"~",m1)  
}

for (i in ivs4) {
models[[i]] <- paste0(i,"~",m1)  
}

# Estimate logit models
fits <- list()
for (i in ivs) {
  for (z in models[[i]]) {
    fits[[z]] <- glm(formula =z, data = data1,family = "binomial")
  }
}
fit1 <- fits
# change model names within list
names(fit1) <- paste0(ivs)

# Tables_______________________________________________________________________
omit <- "(Intercept)|(mujer)|(pospol)"
# detail for subsections:
# https://stackoverflow.com/questions/69338331/r-markdown-create-section-headers-in-r-and-print-r-output-in-same-section

caption <- "Voting behaviour, parental education and conversation (fixed t1)"
knitreg(l = fit1[names(fit1)[grepl("vot", names(fit1),"\n")]],
        omit.coef = omit,
        caption = caption,
        caption.above = T
        # reorder.coef = reorderc
        )

```

- The following models assume the dependent variable as **binary** using the longitudinal nested structure 

```{r vot-long, results='asis'}
rm(list=ls())
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(dplyr,       # Manipulacion de datos 
               haven,       # importar datos en .dta o .sav
               sjmisc,      # descriptivos y frecuencias
               # sjPlot,      # tablas, plots y descriptivos
               sjlabelled,
               summarytools,# resumen de dataframe
               knitr,       # tablas kable
               kableExtra,  # tablas kable personalizadas
               ggplot2,     # plots
               corrplot,    # plot correlacion
               tibble,
               lavaan,
               texreg,
               mediation,
               estimatr,
               bife
               )

load(here::here("input/data/proc/study1_long.RData"))
#votcons = 3
#votcons = 6

data1<- 
study_1_long %>% 
  dplyr::select(folio_encuestado,momento,vot,educyear,age,agepavg,edhigh,
                conv_t1,
                # conv,
                mujer,pospol) %>%
  dplyr::filter(vot !=2,momento !=3,momento !=6) %>%
  mutate(conv_t1=as.numeric(conv_t1),
         # vot=as.numeric(vot),
         # conv=as.numeric(conv)
         ) %>% 
  na.omit()
dim(data1)

# Models-----------------------------------------------------------------------

data1$momento_f<- factor(data1$momento)
voto_t <- 
lme4::glmer(vot~momento_f+(1|folio_encuestado),
            data = data1,
           family = "binomial"
           )

library(ggeffects)
plot(ggeffects::ggpredict(voto_t, "momento_f"))

voto <- 
lme4::glmer(vot~edhigh+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1|folio_encuestado),
            data = data1,
           family = "binomial"
           )







voto_re_t <- 
lme4::lmer(vot~edhigh+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
            data = data1,
           # family = "binomial"
           )


# voto_conv_int <- 
# lme4::lmer(vot~edhigh*momento+educyear+conv+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
#             data = data1,
#            # family = "binomial"
#            )

# voto_convfix <- 
# lme4::lmer(vot~edhigh+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1|folio_encuestado),
#             data = data1,
#            # family = "binomial"
#            )
# voto_convfix_re_t <- 
# lme4::lmer(vot~edhigh+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
#             data = data1,
#            # family = "binomial"
#            )
# 
# voto_convfix_int1 <- 
# lme4::lmer(vot~edhigh*momento+educyear+conv_t1+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
#             data = data1,
#            # family = "binomial"
#            )
# 
# voto_convfix_int2 <- 
# lme4::lmer(vot~edhigh+educyear+conv_t1*momento+mujer+age+agepavg+pospol+momento+I(momento^2)+(1+momento|folio_encuestado),
#             data = data1,
#            # family = "binomial"
#            )

# Table ------------------------------------------------------------------------
votos <- list(voto,voto_re_t,voto_conv_int,
              voto_convfix,voto_convfix_re_t,voto_convfix_int1,voto_convfix_int2)
caption <- "Multilevel longitudinal lineal probability models for voting"
knitreg(votos,
        include.ci = FALSE,
        omit.coef = c("(pospol)|(mujer)|(age)|(agepavg)|(Intercept)"),
        caption.above = T,caption = caption,
        )
```




