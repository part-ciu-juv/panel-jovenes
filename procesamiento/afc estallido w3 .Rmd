---
title: "Análisis Factorial Confirmatorio"
author: "Anais Herrera-Leighton"
output: 
  html_document:
    toc: yes
    code_folding: hide
    toc_float: 
      collapsed: true
      smooth_scroll: false
      number_sections: false
    #css: "https://jciturras.github.io/ayudantia-sol3051/style.css"    

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r}
pacman::p_load(lavaan, haven, dplyr)
```

# Cargar bbdd
```{r}
ola1<-read_dta("../input/data/proc/data_01.dta")
ola2<-read_dta("../input/data/proc/data_02.dta")
ola3<-read_dta("../input/data/proc/data_03.dta")
```


# Tipos de participación y frases a utilizar

__Activismo no disruptivo__

+ Firmar una petición, presencialmente o por internet (part_pol_firma_21)
+ Participar en una marcha o manifestación pacífica (part_pol_marc_pac_21)

__Activismo disruptivo__

+ Participar en una marcha o manifestación con disturbios (part_pol_marc_dis_21)
+ Participar en bloqueo de calles o carreteras (part_pol_bloq_21)
+ Pintar o rayar paredes con demandas o consignas (part_pol_rayar_21)
+ Participar en la toma de un edificio o institución (part_pol_toma_21)

__Activismo online__

+ Usar internet para buscar información sobre temas sociales y/o políticos (part_pol_online_info_21)
+ Postear imágenes o mensajes acerca de temas sociales y/o políticos en internet (part_pol_online_post_21)
+ Compartir o comentar en el posteo de otra persona acerca de temas sociales y políticos (part_pol_online_com_21)
+ Seguir a personas en redes sociales por su contenido sobre temas sociales y políticos (part_pol_online_seg_21)

__Activismo social o comunitario__

+ Trabajar como voluntario en servicios a la comunidad (debido a que es sólo un indicador, **_no_** se incorporará en el AFC)

# Introducción al Análisis Factorial Confirmatorio (AFC)
## Variable: estallido social 
### Descriptivos
```{r}
part_pol_est= data_wide %>% dplyr::select(part_pol_firma_21 , part_pol_marc_pac_21 , part_pol_marc_dis_21, part_pol_bloq_21, part_pol_rayar_21, part_pol_toma_21, part_pol_online_info_21, part_pol_online_post_21, part_pol_online_com_21, part_pol_online_seg_21)
summary(part_pol_est)
```

### Análisis correlacional
```{r}
corMat  <- cor(part_pol_est, use="na.or.complete", method = "kendall")  # estimar matriz pearson
options(digits=3) # decimales
#print(corMat)

#stargazer::stargazer(corMat, title="correlaciones", type = "text") #Latex table
```


```{r }
M=cor(part_pol_est, use="na.or.complete")
corrplot::corrplot(M, type="lower",
      order="AOE", cl.pos="b", tl.pos="d") #agrega nombres en diag.
```

```{r }
sjp.corr(part_pol_est, na.deletion = c("listwise"))
```

### __AFC__

La mayor parte de las mediciones en ciencias sociales son atributos latentes. Lo que se hace típicamente es construir instrumentos que capturaran los conceptos a partir de más de un indicador. En este sentido, lo que se hace es intentar capturar una dimensión latente a partir de atributos (o indicadores) observados. 

El Análisis Factorial Confirmatorio es una técnica orientada a evaluar la validez de la medición de estos constructos latentes (es decir, evaluar si se está midiendo lo que se quiere medir). Dado que los constructos latentes se miden a partir de indicadores observables (o ítems), lo que se hace es evaluar el grado en que los múltiples indicadores covarían entre ellos.

Esto se relaciona con la teoría clásica del test. Como un test puede ser medido a partir de un constructo latente. La teoría dice que el puntaje de un factor latente tiene dos componentes: puntaje verdadero (aquello que realmente es el atributo que estamos capturando) y puntaje error. Al utilizar un sólo indicador se está asumiendo que todo es puntaje verdadero, se asume que ese proxy es suficiente para dar cuenta del constructo, lo cual es un supuesto demasiado grande. Por ende, se busca capturar los constructos latentes a partir de múltiples indicadores, lo que nos permite separar la varianza común (que comparten entre si) de la varianza única (aquella parte del indicador que no es común con el resto). Y, dado que el grupo de indicadores comparte varianza entre sí, se puede asumir que está siendo explicada por un factor latente. 

#### __Análisis de supuestos__

Es relevante preguntarse si ¿hay suficientes correlaciones para pensar que habrá un factor que subyace o explica las correlaciones? antes de pensar en hacer el análisis. Por este motivo es que hacemos la matriz de correlacciones. Hay que fijarse en la dirección, magnitud y significancia. 

En relación a las magnitudes es relevante revisar si hay indicadores que tienen correlaciones más altas entre sí que con otros indicadores, ya que esto de algún modo podría indicar que esos elementos tienen mas varianza común que con los otros (y, por ende, puede que correspondan a una misma subdimensión). 

##### __KMO: factorizabilidad__

```{r }
psych::KMO(corMat) 
```
Los criterios para analizar el valor del estadístico KMO son:

+	0.00 to 0.49 inaceptable.

+	0.50 to 0.59 miserable.

+	0.60 to 0.69 mediocre.

+	0.70 to 0.79 medio.

+	0.80 to 0.89 meritorio.

+	0.90 to 1.00 maravilloso.

##### __Esfericidad__
```{r }
psych::cortest.bartlett(corMat, n = 1101) #el n que se debe indicar es el número de casos de la base de datos que estamos utilizando para el análisis
```

Este criterio alude a en qué medida la varianza de la matriz es suficiente. Si rechazamos la hipótesis nula (p=<0.05) de que la varianza es 0, significa que hay suficientes elementos comunes. En este sentido, como la hipótesis nula es que no hay relaciones, esperamos rechazarla.  

##### __Normalidad (univariada)__
```{r }
shapiro.test(part_pol_est$part_pol_firma_21 )
shapiro.test(part_pol_est$part_pol_marc_pac_21)
shapiro.test(part_pol_est$part_pol_marc_dis_21)
shapiro.test(part_pol_est$part_pol_bloq_21)
shapiro.test(part_pol_est$part_pol_rayar_21)
shapiro.test(part_pol_est$part_pol_toma_21)
shapiro.test(part_pol_est$part_pol_online_info_21)
shapiro.test(part_pol_est$part_pol_online_post_21)
shapiro.test(part_pol_est$part_pol_online_com_21)
shapiro.test(part_pol_est$part_pol_online_seg_21)
```

Este test se debe aplicar a cada una de las variables.

Recordatorio: la hipótesis nula de este test es que la variable se distribuye normalmente. Por lo que si el valor de p es menor o igual a 0.05, se rechaza la hipótesis nula y hay evidencia de que la variable no se distribuye normalmente.

La normalidad de los indicadores no es tan relevante porque hay métodos robustos a la no normalidad, pero por esto mismo es necesario hacer el análisis para elegir el método más adecuado. Por ejemplo, el método de máxima verosimilitud (ml) solo se debe usar cuando las variables si tienen una distribución normal.

#### __Especificación y estimación del modelo__
```{r }

# Especificación del modelo
afc1 <- '
act_no_disrup =~ part_pol_firma_21 + part_pol_marc_pac_21
act_disrup =~ part_pol_marc_dis_21 + part_pol_bloq_21 + part_pol_rayar_21 + part_pol_toma_21
act_online =~ part_pol_online_info_21 + part_pol_online_post_21 + part_pol_online_com_21 + part_pol_online_seg_21
'
```

```{r }
# Estimación del modelo
fit_1 <- lavaan::cfa(afc1, data=part_pol_est, ordered=T)
print(fit_1)
```

#### __Interpretación de resultados__

La estimación arroja una serie de informaciones, tales como ajuste, parámetros estimados, medidas estandarizadas, posibles modificaciones, entre otros (todos los resultados se muestran bajo el código summary). Sin embargo, en esta práctica nos centraremos solo en el ajuste general y solución estandarizada.

```{r}
lavaan::summary(fit_1, fit.measures=T, standardized=T)
```


La función *show* nos muestra el principio de la tabla anterior, donde se presenta el tipo de estimador usado, la medida de ajuste de $\chi^2$ del modelo y los grados de libertad

```{r }
show(fit_1) # Resumen ajuste general
```
El estimador DWLS es uno de los estimadores que se recomiendan para los casos en que no se cumple con el supuesto de normalidad de las variables.

__En relación al $\chi^2$, cabe destacar que se espera no rechazar la hipótesis nula__, es decir, que el test no sea estadísticamente significativo, ya que implicaría que la matriz de varianzas-covarianzas observadas y la matriz implicada en el modelo no difieren significativamente. Además, se debe evaluar __el valor de $\chi^2$/Df y se espera que el valor sea igual o menor a 4.__

Es usual que no los resultados de este indicador muestren que el ajuste no es adecuado cuando el número de casos es alto, por lo que es importante evaluar también la evidencia que brinda los otros indicadores. 

```{r}
lavaan::fitMeasures(fit_1, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "srmr"))
```
__Rangos recomendados:__

+ CFI: Cercano a 0.95 o más

+ TLI: Cercano a 0.95 o más

+ RMSEA: Cercano a 0.06 o menos

+ SRMR: Cercano a 0.08 o menos


#reporte de resultados: 

direccion: 
1) todas las variables tiene correlacion + de mayor a menor grado 
2) info online y toma tuvo correlacion levemente negativa 

magnitud: 
1) baja magnitid toma con rayar 
2) baja magnitud toma rayar con info online 
3) baja margitud entre varibales de part disruptiva con part online 

significacia: 
1) test de k puntaje promedio de 0.83 
2) variable mas baja --> rayar con 0.76 (medio) 
3) todos los estadisticos estan arriba de medio 

esfricidad: 15120
1) rechazamos hipotesis nula de que la varianza es 0 
2) hay suficinetes elementos ocmunes para relaizar analisis factorial 

shapiro:
1) todas las variables son menores a p-value 0.05 
2) se rechaza hipoteisis nula de que ninguna distribuye normalmente


estimacion del modelo: 
1) shi /df = 29.8, valor mayor a 4
2) p-value < 0.05 
3) matriz de varianza-covarianza  y matriz implicada difieren significativamente 
4) cfi mayor que 0.95 (0.991)
5) tli mayor a 0.95 (0.987)
6) rmsa mayor a 0.06 (0.102)
7) srmr mayor a 0.08 (0.102) 
8) valore cercanos o mayores a los indicados, por loq ue el modeolo puede no dar significativo por la gran cantidad de casos 





